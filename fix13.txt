Problem: pdfjs-dist uses DOMMatrix which is a browser-only API, not available in Node.js/Vercel serverless functions.

Solution: Use unpdf library - a modern, lightweight PDF text extraction library specifically designed for Node.js and serverless environments. It has zero browser dependencies.

Step 1: Install unpdf

npm uninstall pdfjs-dist pdf-parse
npm install unpdf
Step 2: Update the API route

File: app/api/extract-text/route.ts

import { NextRequest, NextResponse } from 'next/server';
import { extractText } from 'unpdf';

export async function POST(req: NextRequest) {
  try {
    const formData = await req.formData();
    const file = formData.get('file') as File;

    if (!file) {
      return NextResponse.json({ error: 'No file provided' }, { status: 400 });
    }

    const fileName = file.name.toLowerCase();
    const arrayBuffer = await file.arrayBuffer();
    const buffer = Buffer.from(arrayBuffer);

    let text = '';

    if (fileName.endsWith('.txt')) {
      text = buffer.toString('utf-8');
      
    } else if (fileName.endsWith('.docx')) {
      const mammoth = await import('mammoth');
      const result = await mammoth.extractRawText({ buffer });
      text = result.value;
      
    } else if (fileName.endsWith('.pdf')) {
      // Use unpdf - works in Node.js/serverless without browser APIs
      const result = await extractText(buffer);
      text = result.text;
      
    } else {
      return NextResponse.json(
        { error: 'Unsupported format. Use PDF, DOCX, or TXT.' },
        { status: 400 }
      );
    }

    // Clean text
    text = text
      .replace(/\r\n/g, '\n')
      .replace(/\n{3,}/g, '\n\n')
      .replace(/\s+/g, ' ')
      .trim();

    if (!text || text.length < 20) {
      return NextResponse.json(
        { error: 'Could not extract text from file. It may be image-based or empty.' },
        { status: 400 }
      );
    }

    return NextResponse.json({ 
      success: true, 
      text,
      characterCount: text.length,
    });
    
  } catch (error: any) {
    console.error('Extraction error:', error);
    return NextResponse.json(
      { error: 'Failed to process file: ' + error.message },
      { status: 500 }
    );
  }
}
Step 3: Clean up - remove unused files

rm -f lib/pdfExtractor.ts
rm -f lib/pdfParser.ts
rm -f scripts/test-pdf-extraction.js
rm -f scripts/fix-pdf-parse.js
Step 4: Update package.json - remove postinstall if it references pdf-parse

If your package.json has a postinstall script for pdf-parse, remove it:

{
  "scripts": {
    "dev": "next dev --turbopack",
    "build": "prisma generate && prisma migrate deploy && next build",
    "start": "next start",
    "lint": "next lint"
  }
}
Git commands:

npm uninstall pdfjs-dist pdf-parse
npm install unpdf
git add .
git commit -m "Fix: Use unpdf for PDF extraction - works in serverless without browser APIs"
git push origin main
Why unpdf works:

Library	Browser APIs	Serverless Compatible	Test Files
pdf-parse	❌ Requires test file	❌ No	❌ Missing
pdfjs-dist	❌ Uses DOMMatrix	❌ No	✅ None
unpdf	✅ None	✅ Yes	✅ None
unpdf is specifically built for server-side PDF text extraction and is used by many production applications on Vercel, Cloudflare Workers, and other serverless platforms.

This should finally resolve the PDF extraction issue. Let me know the results after deploying!